import{d as Se,r as _,w as se,c as B,u as ae,a as Ue,b as T,o as Pe,e as d,f as r,g as n,h as s,i as o,j as Ae,k as v,l as b,m as u,F as U,n as E,p as q,q as oe,t as m,s as P,v as Ne,x as De,y as re}from"./app-gvxbI-qR.js";import{_ as L}from"./InputError.vue_vue_type_script_setup_true_lang-DsuSHIY8.js";import{_ as y}from"./index-CRFhrfbN.js";import{_ as H,a as K,b as O,c as R}from"./DialogTitle.vue_vue_type_script_setup_true_lang-COpIkD1s.js";import{_ as Z,a as G}from"./DialogFooter.vue_vue_type_script_setup_true_lang-DC2nHGpr.js";import{_ as Me}from"./Input.vue_vue_type_script_setup_true_lang-DtDy1Dc-.js";import{_ as Q}from"./Label.vue_vue_type_script_setup_true_lang-CcxXtsll.js";import{_ as je}from"./AppLayout.vue_vue_type_script_setup_true_lang-BqS2gj7J.js";import{c as ze}from"./createLucideIcon-C9OiHapd.js";import"./useForwardPropsEmits-CmIdqZXE.js";import"./index-_Siexf_g.js";import"./useForwardExpose-BdnvS-H7.js";import"./VisuallyHidden-DwhrsjEI.js";import"./index-ZplewPxT.js";import"./index-CSEUMRIG.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-CP5RVh-J.js";const Ve=ze("UploadIcon",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Ee={class:"flex flex-col gap-6 p-4"},Fe={class:"flex items-center justify-between"},Ie={class:"flex flex-wrap gap-2"},Be={class:"grid gap-6 lg:grid-cols-[280px_1fr]"},Te={class:"rounded-md border"},qe={class:"divide-y"},Le=["onClick"],He=["onClick"],Ke={key:0,class:"px-4 py-6 text-center text-sm text-muted-foreground"},Oe={class:"rounded-md border"},Re={class:"flex items-center justify-between border-b px-4 py-2"},Ze={class:"text-xs text-muted-foreground"},Ge={class:"w-full text-sm"},Qe={class:"px-4 py-2"},Je={class:"px-4 py-2"},We={class:"px-4 py-2"},Xe={class:"px-4 py-2 text-sm text-muted-foreground"},Ye={class:"inline-flex items-center gap-2"},et={key:0,class:"inline-flex h-3 w-3 animate-spin rounded-full border-2 border-muted-foreground/40 border-t-muted-foreground"},tt={class:"px-4 py-2 text-sm text-muted-foreground"},st={class:"inline-flex items-center gap-2"},at={key:0,class:"inline-flex h-3 w-3 animate-spin rounded-full border-2 border-muted-foreground/40 border-t-muted-foreground"},ot={class:"px-4 py-2"},rt=["href"],nt=["onClick"],lt=["onClick"],it={key:0},dt={class:"grid gap-2"},ut={class:"grid gap-2"},ct=["value","disabled"],pt={class:"grid gap-2"},ft=["onKeydown"],vt={class:"flex h-14 w-14 items-center justify-center rounded-full bg-muted-foreground/15 text-foreground"},mt=["disabled"],_t={key:0,class:"text-xs text-destructive"},ht={key:0,class:"min-h-0 flex-1 overflow-auto rounded-md border"},gt={class:"w-full table-fixed text-xs"},xt={class:"px-3 py-2"},bt={class:"truncate"},yt={key:0,class:"text-destructive"},wt={class:"px-3 py-2 text-muted-foreground"},kt={class:"px-3 py-2"},$t={class:"flex items-center gap-2"},Ct={class:"h-1.5 w-24 rounded-full bg-muted"},St={class:"text-muted-foreground"},Ut={class:"flex max-h-[70vh] flex-col gap-4"},Pt={key:0,class:"text-sm text-muted-foreground"},At={key:1},Nt={key:2,class:"min-h-0 flex-1 overflow-auto"},Dt=["src"],Mt={key:3,class:"flex items-center justify-between"},jt={class:"text-sm text-muted-foreground"},Jt=Se({__name:"Archives",props:{archives:{},documents:{}},setup(ne){const w=ne,le=[{title:"Archiv",href:"/archives"}],p=_(null);se(()=>{!p.value&&w.archives.length>0&&(p.value=w.archives[0].id)});function ie(a){const e=new Map;a.forEach(g=>{const l=g.parent_id??null;e.has(l)||e.set(l,[]),e.get(l).push(g)});const t=[];function f(g,l){(e.get(g)??[]).forEach(S=>{t.push({archive:S,depth:l}),f(S.id,l+1)})}return f(null,0),t}const J=B(()=>ie(w.archives)),W=B(()=>p.value?w.documents.filter(a=>a.archive_id===p.value):[]);function de(a){if(!a&&a!==0)return"-";if(a<1024)return`${a} B`;const e=["KB","MB","GB","TB"];let t=a/1024,f=0;for(;t>=1024&&f<e.length-1;)t/=1024,f+=1;const g=t>=10?Math.round(t):Math.round(t*10)/10;return`${String(g).replace(".",",")} ${e[f]}`}const C=_(!1),k=_(null),A=_(!1),N=_(!1),F=_(!1),D=_([]),X=_(null),i=ae({name:"",parent_id:""});function M(){C.value=!1,k.value=null,i.reset(),i.clearErrors()}function ue(a){if(!a){M();return}C.value=!0}function Y(){A.value=!1,D.value=[],x.reset(),x.clearErrors()}function ce(a){if(!a){Y();return}A.value=!0}function pe(){k.value=null,i.reset(),i.parent_id=p.value?String(p.value):"",i.clearErrors(),C.value=!0}function fe(a){k.value=a,i.name=a.name,i.parent_id=a.parent_id?String(a.parent_id):"",i.clearErrors(),C.value=!0}function ve(){const a={name:i.name,parent_id:i.parent_id?Number(i.parent_id):null};if(k.value){i.put(`/archives/${k.value.id}`,{data:a,onSuccess:M});return}i.post("/archives",{data:a,onSuccess:M})}const x=ae({archive_id:"",file:null});function ee(a){if(!p.value||a.length===0||F.value)return;const e=new Set(w.documents.filter(l=>l.archive_id===p.value).map(l=>`${l.original_filename??l.name}:${l.size??0}`)),t=new Set,f=a.map(l=>{const V=`${l.name}:${l.size}`,S=e.has(V)||t.has(V);return t.add(V),{id:`${l.name}-${l.size}-${l.lastModified}`,name:l.name,size:l.size,progress:0,status:S?"duplicate":"queued",message:S?"Súbor už existuje v tomto adresári.":void 0,file:l}});D.value=f;const g=f.filter(l=>l.status==="queued");g.length!==0&&me(g)}async function me(a){F.value=!0;for(const e of a)await _e(e);F.value=!1}function _e(a){return x.clearErrors(),x.archive_id=String(p.value??""),x.file=a.file,a.status="uploading",a.progress=0,new Promise(e=>{x.post("/archive-documents",{forceFormData:!0,onProgress:t=>{a.progress=t.percentage},onSuccess:()=>{a.status="done",a.progress=100},onError:t=>{const f=t.file??t.archive_id??"Nepodarilo sa nahrať súbor.";a.status=f==="Súbor už existuje v tomto adresári."?"duplicate":"error",a.message=f},onFinish:()=>{x.reset("file"),e()}})})}function he(a){const e=a.target,t=e.files?Array.from(e.files):[];ee(t),e.value=""}function ge(a){a.preventDefault(),N.value=!1;const e=a.dataTransfer?.files?Array.from(a.dataTransfer.files):[];ee(e)}function xe(a){a.preventDefault(),N.value=!0}function be(a){a.preventDefault(),N.value=!1}function I(){p.value&&X.value?.click()}function ye(a){T.post(`/archive-documents/${a}/ocr`,{},{preserveScroll:!0})}const j=_(!1),c=_(null),h=_(1);let z=null;const we=B(()=>!c.value||c.value.preview_status!=="done"?"":`/archive-documents/${c.value.id}/preview/${h.value}`);function ke(a){c.value=a,h.value=1,j.value=!0,a.preview_status!=="done"&&T.post(`/archive-documents/${a.id}/preview`,{},{preserveScroll:!0})}function te(){j.value=!1,c.value=null,h.value=1,$()}function $e(){h.value>1&&(h.value-=1)}function Ce(){const a=c.value?.preview_page_count??0;h.value<a&&(h.value+=1)}function $(){z&&(clearInterval(z),z=null)}return Ue(()=>j.value,a=>{if(!a){$();return}if(!c.value||c.value.preview_status==="done"){$();return}$(),z=setInterval(()=>{T.reload({only:["documents"],preserveScroll:!0})},3e3)}),se(()=>{if(!c.value)return;const a=w.documents.find(e=>e.id===c.value?.id);a&&(c.value=a),c.value.preview_status==="done"&&$()}),Pe(()=>{$()}),(a,e)=>(u(),d(U,null,[r(je,{breadcrumbs:le},{default:n(()=>[r(o(Ae),{title:"Archiv"}),s("div",Ee,[s("div",Fe,[e[6]||(e[6]=s("h1",{class:"text-2xl font-semibold"},"Archiv",-1)),s("div",Ie,[r(o(y),{variant:"outline",onClick:pe},{default:n(()=>[...e[4]||(e[4]=[v(" Pridať adresár ",-1)])]),_:1}),r(o(y),{disabled:!p.value,onClick:e[0]||(e[0]=t=>A.value=!0)},{default:n(()=>[...e[5]||(e[5]=[v(" Pridať súbory ",-1)])]),_:1},8,["disabled"])])]),s("div",Be,[s("div",Te,[e[7]||(e[7]=s("div",{class:"border-b px-4 py-2 text-sm font-medium"}," Adresáre ",-1)),s("div",qe,[(u(!0),d(U,null,E(J.value,t=>(u(),d("button",{key:t.archive.id,type:"button",class:q(["flex w-full items-center justify-between px-4 py-2 text-left text-sm hover:bg-accent",p.value===t.archive.id?"bg-accent":""]),onClick:f=>p.value=t.archive.id},[s("span",{class:"truncate",style:oe({paddingLeft:`${t.depth*16}px`})},m(t.archive.name),5),s("span",{class:"ml-2 text-xs text-muted-foreground",onClick:P(f=>fe(t.archive),["stop"])}," Upraviť ",8,He)],10,Le))),128)),J.value.length===0?(u(),d("div",Ke," Žiadne adresáre. ")):b("",!0)])]),s("div",Oe,[s("div",Re,[e[8]||(e[8]=s("div",{class:"text-sm font-medium"},"Dokumenty",-1)),s("div",Ze,m(p.value?`Adresar #${p.value}`:"Vyber adresár"),1)]),s("table",Ge,[e[10]||(e[10]=s("thead",{class:"bg-muted"},[s("tr",null,[s("th",{class:"px-4 py-2 text-left font-medium"}," Názov "),s("th",{class:"px-4 py-2 text-left font-medium"}," Typ "),s("th",{class:"px-4 py-2 text-left font-medium"}," Veľkosť "),s("th",{class:"px-4 py-2 text-left font-medium"}," Náhľad "),s("th",{class:"px-4 py-2 text-left font-medium"}," OCR "),s("th",{class:"px-4 py-2 text-left font-medium"}," Akcie ")])],-1)),s("tbody",null,[(u(!0),d(U,null,E(W.value,t=>(u(),d("tr",{key:t.id,class:"border-t"},[s("td",Qe,m(t.name),1),s("td",Je,m(t.type),1),s("td",We,m(de(t.size)),1),s("td",Xe,[s("span",Ye,[t.preview_status==="processing"?(u(),d("span",et)):b("",!0),v(" "+m(t.preview_status==="done"?"Hotovo":t.preview_status==="processing"?"Generuje sa":t.preview_status==="queued"?"V rade":t.preview_status==="failed"?"Chyba":"Nezadané"),1)])]),s("td",tt,[s("span",st,[t.ocr_status==="processing"?(u(),d("span",at)):b("",!0),v(" "+m(t.ocr_status==="done"?"Hotovo":t.ocr_status==="processing"?"Spracúva sa":t.ocr_status==="queued"?"V rade":t.ocr_status==="failed"?"Chyba":"Nezadané"),1)])]),s("td",ot,[s("a",{href:`/archive-documents/${t.id}/download`,class:"text-sm font-medium underline underline-offset-4"}," Stiahnuť ",8,rt),s("button",{type:"button",class:"ml-3 text-sm font-medium underline underline-offset-4",onClick:f=>ke(t)}," Zobraziť ",8,nt),s("button",{type:"button",class:"ml-3 text-sm font-medium underline underline-offset-4",onClick:f=>ye(t.id)}," Spustiť OCR ",8,lt)])]))),128)),W.value.length===0?(u(),d("tr",it,[...e[9]||(e[9]=[s("td",{class:"px-4 py-6 text-center text-muted-foreground",colspan:"6"}," Žiadne dokumenty. ",-1)])])):b("",!0)])])])])])]),_:1}),r(o(R),{open:C.value,"onUpdate:open":ue},{default:n(()=>[r(o(H),{class:"sm:max-w-lg"},{default:n(()=>[r(o(K),null,{default:n(()=>[r(o(O),null,{default:n(()=>[v(m(k.value?"Upraviť adresár":"Pridať adresár"),1)]),_:1})]),_:1}),s("form",{class:"space-y-4",onSubmit:P(ve,["prevent"])},[s("div",dt,[r(o(Q),{for:"archive-name"},{default:n(()=>[...e[11]||(e[11]=[v("Názov",-1)])]),_:1}),r(o(Me),{id:"archive-name",name:"name",modelValue:o(i).name,"onUpdate:modelValue":e[1]||(e[1]=t=>o(i).name=t),autocomplete:"off"},null,8,["modelValue"]),r(L,{message:o(i).errors.name},null,8,["message"])]),s("div",ut,[r(o(Q),{for:"archive-parent"},{default:n(()=>[...e[12]||(e[12]=[v("Nadradený adresár",-1)])]),_:1}),Ne(s("select",{id:"archive-parent",class:"w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-xs outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","onUpdate:modelValue":e[2]||(e[2]=t=>o(i).parent_id=t)},[e[13]||(e[13]=s("option",{value:""},"-- koreň --",-1)),(u(!0),d(U,null,E(w.archives,t=>(u(),d("option",{key:t.id,value:t.id,disabled:k.value?.id===t.id},m(t.name),9,ct))),128))],512),[[De,o(i).parent_id]]),r(L,{message:o(i).errors.parent_id},null,8,["message"])]),r(o(Z),{class:"gap-2"},{default:n(()=>[r(o(G),{"as-child":""},{default:n(()=>[r(o(y),{type:"button",variant:"outline",onClick:M},{default:n(()=>[...e[14]||(e[14]=[v(" Zrušiť ",-1)])]),_:1})]),_:1}),r(o(y),{type:"submit",disabled:o(i).processing},{default:n(()=>[...e[15]||(e[15]=[v(" Uložiť ",-1)])]),_:1},8,["disabled"])]),_:1})],32)]),_:1})]),_:1},8,["open"]),r(o(R),{open:A.value,"onUpdate:open":ce},{default:n(()=>[r(o(H),{class:"sm:max-w-5xl max-h-[85vh] overflow-hidden"},{default:n(()=>[r(o(K),null,{default:n(()=>[r(o(O),null,{default:n(()=>[...e[16]||(e[16]=[v("Pridať súbory",-1)])]),_:1})]),_:1}),s("form",{class:"flex max-h-[70vh] flex-col gap-4",onSubmit:e[3]||(e[3]=P(()=>{},["prevent"]))},[s("div",pt,[r(o(Q),{for:"archive-upload"},{default:n(()=>[...e[17]||(e[17]=[v("Súbory",-1)])]),_:1}),s("div",{class:q(["flex cursor-pointer flex-col items-center justify-center gap-3 rounded-md border border-dashed bg-muted/40 p-8 text-sm text-muted-foreground",N.value?"bg-accent":""]),role:"button",tabindex:"0",onClick:I,onKeydown:[re(P(I,["prevent"]),["enter"]),re(P(I,["prevent"]),["space"])],onDrop:ge,onDragover:xe,onDragleave:be},[s("div",vt,[r(o(Ve),{class:"h-7 w-7"})]),e[18]||(e[18]=s("div",{class:"text-sm font-medium text-foreground"}," Pretiahni súbory sem alebo klikni sem. ",-1)),s("input",{id:"archive-upload",ref_key:"uploadInputRef",ref:X,type:"file",class:"hidden",multiple:"",disabled:!p.value,onChange:he},null,40,mt)],42,ft),p.value?b("",!0):(u(),d("div",_t," Najprv vyber adresár. ")),r(L,{message:o(x).errors.file},null,8,["message"])]),D.value.length>0?(u(),d("div",ht,[s("table",gt,[e[19]||(e[19]=s("thead",{class:"bg-muted"},[s("tr",null,[s("th",{class:"w-1/2 px-3 py-2 text-left font-medium"}," Súbor "),s("th",{class:"w-1/5 px-3 py-2 text-left font-medium"}," Stav "),s("th",{class:"w-1/3 px-3 py-2 text-left font-medium"}," Priebeh ")])],-1)),s("tbody",null,[(u(!0),d(U,null,E(D.value,t=>(u(),d("tr",{key:t.id,class:"border-t"},[s("td",xt,[s("div",bt,m(t.name),1),t.message?(u(),d("div",yt,m(t.message),1)):b("",!0)]),s("td",wt,m(t.status==="done"?"Hotovo":t.status==="uploading"?"Nahráva sa":t.status==="duplicate"?"Duplicita":t.status==="error"?"Chyba":"Čaká"),1),s("td",kt,[s("div",$t,[s("div",Ct,[s("div",{class:q(["h-1.5 rounded-full transition-all",t.status==="done"?"bg-primary":t.status==="error"?"bg-destructive":t.status==="duplicate"?"bg-muted-foreground":"bg-primary/60"]),style:oe({width:t.status==="duplicate"?"100%":`${t.progress}%`})},null,6)]),s("span",St,m(t.status==="duplicate"?"100%":`${t.progress}%`),1)])])]))),128))])])])):b("",!0),r(o(Z),{class:"gap-2"},{default:n(()=>[r(o(G),{"as-child":""},{default:n(()=>[r(o(y),{type:"button",variant:"outline",onClick:Y},{default:n(()=>[...e[20]||(e[20]=[v(" Zrušiť ",-1)])]),_:1})]),_:1})]),_:1})],32)]),_:1})]),_:1},8,["open"]),r(o(R),{open:j.value,"onUpdate:open":te},{default:n(()=>[r(o(H),{class:"sm:max-w-5xl max-h-[85vh] overflow-hidden"},{default:n(()=>[r(o(K),null,{default:n(()=>[r(o(O),null,{default:n(()=>[...e[21]||(e[21]=[v("Náhľad dokumentu",-1)])]),_:1})]),_:1}),s("div",Ut,[c.value?c.value.preview_status!=="done"?(u(),d("div",At,[...e[22]||(e[22]=[s("div",{class:"flex items-center gap-3 text-sm text-muted-foreground"},[s("span",{class:"inline-flex h-4 w-4 animate-spin rounded-full border-2 border-muted-foreground/40 border-t-muted-foreground"}),s("span",null,"Náhľad sa generuje. Skús to o chvíľu znova.")],-1)])])):(u(),d("div",Nt,[s("img",{src:we.value,alt:"Náhľad dokumentu",class:"mx-auto max-h-[60vh] w-auto rounded-md border"},null,8,Dt)])):(u(),d("div",Pt," Vyber dokument. ")),c.value&&c.value.preview_status==="done"?(u(),d("div",Mt,[r(o(y),{variant:"outline",size:"sm",disabled:h.value<=1,onClick:$e},{default:n(()=>[...e[23]||(e[23]=[v(" Predchádzajúca ",-1)])]),_:1},8,["disabled"]),s("div",jt," Strana "+m(h.value)+" / "+m(c.value.preview_page_count??1),1),r(o(y),{variant:"outline",size:"sm",disabled:h.value>=(c.value.preview_page_count??1),onClick:Ce},{default:n(()=>[...e[24]||(e[24]=[v(" Nasledujúca ",-1)])]),_:1},8,["disabled"])])):b("",!0),r(o(Z),{class:"gap-2"},{default:n(()=>[r(o(G),{"as-child":""},{default:n(()=>[r(o(y),{type:"button",variant:"outline",onClick:te},{default:n(()=>[...e[25]||(e[25]=[v(" Zavrieť ",-1)])]),_:1})]),_:1})]),_:1})])]),_:1})]),_:1},8,["open"])],64))}});export{Jt as default};
